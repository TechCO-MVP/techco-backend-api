service: backend-proposal-v2

provider:
  name: aws
  architecture: x86_64
  stage: ${opt:stage, 'dev'}
  region: us-east-1

S3RawProfileDataIA:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: ${self:provider.stage}-raw-profile-data-infrequent-access
    AccessControl: Private
    LifecycleConfiguration:
      Rules:
        - Id: DeleteOldRawProfileData
          Status: Enabled
          ExpirationInDays: 45
          Transitions:
            - StorageClass: STANDARD_IA
              TransitionInDays: 30
    Tags:
      - Key: Environment
        Value: ${self:provider.stage}
      - Key: Name
        Value: ${self:provider.stage}-raw-profile-data-infrequent-access

S3DepuratedProfileDataIA:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: ${self:provider.stage}-depurated-profile-data-infrequent-access
    AccessControl: Private
    LifecycleConfiguration:
      Rules:
        - Id: DeleteOldDepuratedProfileData
          Status: Enabled
          ExpirationInDays: 45
          Transitions:
            - StorageClass: STANDARD_IA
              TransitionInDays: 30
    Tags:
      - Key: Environment
        Value: ${self:provider.stage}
      - Key: Name
        Value: ${self:provider.stage}-depurated-profile-data-infrequent-access

S3RefinedProfileDataIA:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: ${self:provider.stage}-refined-profile-data-infrequent-access
    AccessControl: Private
    LifecycleConfiguration:
      Rules:
        - Id: DeleteOldRefinedProfileData
          Status: Enabled
          ExpirationInDays: 45
          Transitions:
            - StorageClass: STANDARD_IA
              TransitionInDays: 30
    Tags:
      - Key: Environment
        Value: ${self:provider.stage}
      - Key: Name
        Value: ${self:provider.stage}-refined-profile-data-infrequent-access


stateMachines:
  profileFilterProcess:
    name: ProfileFilterProcess-${self:provider.stage}
    definition:
      Comment: "A simple AWS Step Functions state machine that filters profiles"
      StartAt: FilterProfiles
      States:
        FilterProfiles:
          Type: Task
          Resource:
            Fn::GetAtt:
              - profile_query_brightdata
              - Arn
          Next: CheckSnapshotStatus
        CheckSnapshotStatus:
          Type: Task
          Resource:
            Fn::GetAtt:
              - check_snapshot_status_brightdata
              - Arn
          Retry:
            - ErrorEquals: ["States.ALL"]
              IntervalSeconds: 150
              MaxAttempts: 4
          Catch:
            - ErrorEquals: ["States.ALL"]
              Next: Fail
          Next: GetSnapshotData
        GetSnapshotData:
          Type: Task
          Resource:
            Fn::GetAtt:
              - get_snapshot_data_brightdata
              - Arn
          Next: TransformAndRefine
        TransformAndRefine:
          Type: Task
          Resource:
            Fn::GetAtt:
              - transform_and_refine_brightdata
              - Arn
          Next: QueryAndBuildOpenAIData
        QueryAndBuildOpenAIData:
          Type: Task
          Resource:
            Fn::GetAtt:
              - query_and_build_openai_data
              - Arn
          Next: NotifyCompletion
        NotifyCompletion:
          Type: Task
          Resource:
            Fn::GetAtt:
              - notify_completion_profile_filter_process
              - Arn
          End: true
        Fail:
          Type: Task
          Resource:
            Fn::GetAtt:
              - notify_failure_profile_filter_process
              - Arn
          End: true
