service: backend-proposal-v2

provider:
  name: aws
  architecture: x86_64
  stage: ${opt:stage, 'dev'}
  region: us-east-1

stateMachines:
  profileFilterProcess:
    name: ProfileFilterProcess-${self:provider.stage}
    definition:
      Comment: "A simple AWS Step Functions state machine that filters profiles"
      StartAt: FilterProfiles
      States:
        FilterProfiles:
          Type: Task
          Resource:
            Fn::GetAtt:
              - profile_query_brightdata
              - Arn
          Next: CheckSnapshotStatus
        CheckSnapshotStatus:
          Type: Task
          Resource:
            Fn::GetAtt:
              - check_snapshot_status_brightdata
              - Arn
          Retry:
            - ErrorEquals: ["States.ALL"]
              IntervalSeconds: 150
              MaxAttempts: 4
          Catch:
            - ErrorEquals: ["States.ALL"]
              Next: Fail
          Next: GetSnapshotData
        GetSnapshotData:
          Type: Task
          Resource:
            Fn::GetAtt:
              - get_snapshot_data_brightdata
              - Arn
          Next: TransformAndRefine
        TransformAndRefine:
          Type: Task
          Resource:
            Fn::GetAtt:
              - transform_and_refine_brightdata
              - Arn
          Next: QueryAndBuildOpenAIData
        QueryAndBuildOpenAIData:
          Type: Task
          Resource:
            Fn::GetAtt:
              - query_and_build_openai_data
              - Arn
          Next: NotifyCompletion
        NotifyCompletion:
          Type: Task
          Resource:
            Fn::GetAtt:
              - notify_completion_profile_filter_process
              - Arn
          End: true
        Fail:
          Type: Task
          Resource:
            Fn::GetAtt:
              - notify_failure_profile_filter_process
              - Arn
          End: true
